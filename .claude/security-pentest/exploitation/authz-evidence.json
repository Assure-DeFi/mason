{
  "category": "authz",
  "tested_at": "2026-02-06T22:57:09-05:00",
  "findings": [
    {
      "id": "AUTHZ-013",
      "status": "confirmed",
      "severity": "medium",
      "title": "SECURITY DEFINER functions granted to anon role expose DLQ metrics",
      "exploit_request": {
        "method": "GET",
        "url": "http://localhost:3000/api/health",
        "headers": {},
        "body": null
      },
      "exploit_response": {
        "status_code": 200,
        "body_preview": "{\"status\":\"ok\",\"timestamp\":1770436694445,\"dlq\":null}"
      },
      "proof_of_concept": "curl -s http://localhost:3000/api/health",
      "impact_demonstrated": "Public /api/health endpoint calls get_dlq_metrics() RPC function without authentication. The function is marked SECURITY DEFINER and granted to 'anon' role, allowing unauthenticated access to DLQ error counts, error types, and failure patterns. In production with configured Supabase, this would expose internal error metrics including consecutive failure counts and error type distribution.",
      "vulnerability_details": {
        "security_definer_functions": [
          "get_dlq_metrics()",
          "bulk_retry_dlq(UUID[], INTEGER)"
        ],
        "granted_to": "anon, authenticated",
        "rls_policy": "USING (true) WITH CHECK (true) - permissive",
        "public_endpoint": "/api/health",
        "data_exposed": [
          "total_count",
          "last_24h_count",
          "last_hour_count",
          "oldest_entry",
          "newest_entry",
          "max_consecutive_failures",
          "error_types with counts"
        ]
      },
      "file": "packages/mason-dashboard/src/app/api/setup/migrations/route.ts",
      "line": 679,
      "additional_references": [
        {
          "file": "packages/mason-dashboard/src/app/api/setup/migrations/route.ts",
          "line": 717,
          "note": "bulk_retry_dlq() also SECURITY DEFINER + granted to anon"
        },
        {
          "file": "packages/mason-dashboard/src/app/api/health/route.ts",
          "line": 53,
          "note": "Public endpoint calling get_dlq_metrics() without auth check"
        }
      ],
      "recommendation": "Remove GRANT EXECUTE to 'anon' role. Only grant to 'authenticated'. Add session validation in /api/health before calling RPC function."
    },
    {
      "id": "AUTHZ-004",
      "status": "not_exploitable",
      "severity": "medium",
      "title": "Mass assignment in events endpoint",
      "exploit_request": {
        "method": "POST",
        "url": "http://localhost:3000/api/backlog/00000000-0000-0000-0000-000000000001/events",
        "headers": {
          "Content-Type": "application/json"
        },
        "body": "{\"event_type\": \"note_added\", \"notes\": \"test\", \"dbUserId\": \"injected-user-id\"}"
      },
      "exploit_response": {
        "status_code": 401,
        "body_preview": "{\"success\":false,\"error\":{\"code\":\"UNAUTHORIZED\",\"message\":\"Authentication required\"}}"
      },
      "proof_of_concept": "curl -s -X POST http://localhost:3000/api/backlog/00000000-0000-0000-0000-000000000001/events -H 'Content-Type: application/json' -d '{\"event_type\": \"note_added\", \"notes\": \"test\", \"dbUserId\": \"injected-user-id\"}'",
      "impact_demonstrated": "Endpoint requires authentication. Cannot exploit without valid session. Mass assignment risk exists in code but is mitigated by auth requirement.",
      "file": "src/app/api/backlog/[id]/events/route.ts",
      "line": 0,
      "recommendation": "Although auth protects this endpoint, the mass assignment vulnerability should still be fixed by explicitly selecting only allowed fields from request body instead of spreading entire body into database insert."
    },
    {
      "id": "AUTHZ-005",
      "status": "not_exploitable",
      "severity": "high",
      "title": "Restore endpoint creates orphaned items",
      "exploit_request": {
        "method": "POST",
        "url": "http://localhost:3000/api/backlog/restore",
        "headers": {
          "Content-Type": "application/json"
        },
        "body": "{\"filteredItemId\": \"00000000-0000-0000-0000-000000000001\"}"
      },
      "exploit_response": {
        "status_code": 401,
        "body_preview": "{\"success\":false,\"error\":{\"code\":\"UNAUTHORIZED\",\"message\":\"Authentication required\"}}"
      },
      "proof_of_concept": "curl -s -X POST http://localhost:3000/api/backlog/restore -H 'Content-Type: application/json' -d '{\"filteredItemId\": \"00000000-0000-0000-0000-000000000001\"}'",
      "impact_demonstrated": "Endpoint requires authentication. Cannot exploit without valid session.",
      "file": "src/app/api/backlog/restore/route.ts",
      "line": 0,
      "recommendation": "Auth partially mitigates this. However, the underlying issue (creating backlog items without repository_id validation) should still be fixed to prevent authenticated users from creating orphaned items."
    },
    {
      "id": "AUTHZ-006",
      "status": "not_exploitable",
      "severity": "high",
      "title": "SQL query proxy no Mason session validation",
      "exploit_request": {
        "method": "POST",
        "url": "http://localhost:3000/api/supabase/projects/aaaabbbbccccddddeeee/query",
        "headers": {
          "Authorization": "Bearer fake_token",
          "Content-Type": "application/json"
        },
        "body": "{\"query\": \"SELECT 1\", \"read_only\": true}"
      },
      "exploit_response": {
        "status_code": 401,
        "body_preview": "{\"success\":false,\"error\":{\"code\":\"EXTERNAL_SERVICE_ERROR\",\"message\":\"JWT could not be decoded\"}}"
      },
      "proof_of_concept": "curl -s -X POST http://localhost:3000/api/supabase/projects/aaaabbbbccccddddeeee/query -H 'Authorization: Bearer fake_token' -H 'Content-Type: application/json' -d '{\"query\": \"SELECT 1\", \"read_only\": true}'",
      "impact_demonstrated": "Endpoint validates JWT token. Invalid token returns 401. Cannot exploit without valid Bearer token.",
      "file": "src/app/api/supabase/projects/[projectRef]/query/route.ts",
      "line": 0,
      "recommendation": "Although JWT validation prevents exploitation, consider adding explicit Mason session validation for defense in depth."
    },
    {
      "id": "AUTHZ-007",
      "status": "not_exploitable",
      "severity": "medium",
      "title": "API keys proxy no session validation",
      "exploit_request": {
        "method": "GET",
        "url": "http://localhost:3000/api/supabase/projects/aaaabbbbccccddddeeee/api-keys",
        "headers": {
          "Authorization": "Bearer fake_token"
        },
        "body": null
      },
      "exploit_response": {
        "status_code": 401,
        "body_preview": "{\"success\":false,\"error\":{\"code\":\"EXTERNAL_SERVICE_ERROR\",\"message\":\"JWT could not be decoded\"}}"
      },
      "proof_of_concept": "curl -s http://localhost:3000/api/supabase/projects/aaaabbbbccccddddeeee/api-keys -H 'Authorization: Bearer fake_token'",
      "impact_demonstrated": "Endpoint validates JWT token. Invalid token returns 401. Cannot exploit without valid Bearer token.",
      "file": "src/app/api/supabase/projects/[projectRef]/api-keys/route.ts",
      "line": 0,
      "recommendation": "Although JWT validation prevents exploitation, consider adding explicit Mason session validation for defense in depth."
    }
  ],
  "summary": {
    "total_tested": 5,
    "confirmed": 1,
    "not_exploitable": 4,
    "high_severity_confirmed": 0,
    "medium_severity_confirmed": 1,
    "low_severity_confirmed": 0
  },
  "notes": [
    "AUTHZ-009 (Health endpoint DLQ) was already tested by auth agent and is duplicate of AUTHZ-013",
    "AUTHZ-013 is the only confirmed exploitable vulnerability - public endpoint exposes DLQ metrics via SECURITY DEFINER function granted to anon role",
    "All other endpoints properly validate authentication/authorization",
    "The confirmed vulnerability requires Supabase to be configured to leak actual data, but the access control weakness exists in code"
  ]
}
